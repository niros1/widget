<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gusteau's Restaurant</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
</head>
<!-- this is a quick & (very) dirty web page to host the widget -->
<body>
    <div id="gusteau">
        <h1>Gusteau's Restaurant</h1>
        <div id="responsive-content">
            <div>
                <label for="lang">Website language:</label>
                <select id="lang">
                    <option value="nl-NL">ðŸ‡³ðŸ‡± Dutch</option>
                    <option value="en-US" selected>ðŸ‡ºðŸ‡¸ English</option>
                    <option value="en-GB">ðŸ‡¬ðŸ‡§ English</option>
                    <option value="fi-FI">ðŸ‡«ðŸ‡® Finnish</option>
                    <option value="fr-FR">ðŸ‡«ðŸ‡· French</option>
                    <option value="el-GR">ðŸ‡¬ðŸ‡· Greek</option>
                    <option value="he-IL">ðŸ‡®ðŸ‡± Hebrew</option>
                    <option value="es-ES">ðŸ‡ªðŸ‡¸ Spanish</option>
                    <option value="de-DE">ðŸ‡©ðŸ‡ª German (not supported yet)</option>
                </select>
                <div id="tableBooking">
                    <span>Get a table:</span>
                    <ul>
                        <li><label>On 8:40<sup style="font-variant: small-caps">pm</sup> of <input type="date" id="tableBookingDate"></label></li>
                        <li><label>For a party of <input type="number" min="0" max="10" value="1" onchange="hmw({passengers: this.value})"></label></li>
                    </ul>
                </div>
            </div>
            <div id="remy">
                <img src="Remy.png" width="100" height="180">
                <textarea cols="50" rows="5" id="logger" title="widget messages">Messages from the widget:</textarea>
            </div>
        </div>
    </div>
    <button id="toggle">Show / Hide (focus on Widget)</button>
    <input id="niceFont" type="checkbox"><label for="niceFont" style="font-size: 66%">Nice Font (refresh to affect the Widget)</label>
    <div id="mobility">
        <p id="ourLocation">We are located at 170 Rue de Rivoli, Paris.</p>

        <div id="here-mobility-widget">
            <script>
              (function(w,i,d,g,e,t){
                var h='HereMobilityWidget';w[h]=w[h]||[];w[h].push(e);if(!(e in w)){w[e]=function(o){w[e].q.push(o)};w[e].q=[{el:g}]}w[e].t=Date.now();
                var s=i.createElement('script');s.async=1;s.src=d+'?a='+t+'&b='+(w[e].t/864e5|0);i.querySelector('#'+g).appendChild(s);
              })(window,document,'widget.js','here-mobility-widget','hmw','2jHx6BkEPg10lj3MXi5MasvvQxwevNXs');
            </script>
        </div>
        <!-- http://localhost:3000/djs -->
    </div>
    <div id="astray"></div>
    <div id="i18nPanel"></div>

    <script type="text/javascript" src="sha256.js"></script>
    <script>
      const getQueryParam = name => {
        let s = location.search
        s = s[0] === '?' ? s.slice(1) : s // remove opening '?'
        return s
          .split('&') // array of key-value pairs
          .filter(kv => kv.split('=')[0] === name) // get only pair(s) with desired key
          .map(kv => kv.split('=')[1]) // return the value(s)
        }
      /*
        Example URL: http://localhost:1234/gusteau.html?authSecret=XXX&authAppkey=YYYY&authUser=ZZZ&isDev={true/false}
      */
      const getAuthParams = () => {
        const queryString = location.search
        let param_auth_secret
        let param_auth_appkey
        let param_auth_user
        let param_is_dev

        if (queryString) {
          // const urlParams = new URLSearchParams(location.search)
          param_auth_secret = getQueryParam('authSecret')[0]
          param_auth_appkey = getQueryParam('authAppkey')[0]
          param_auth_user = getQueryParam('authUser')[0]
          param_is_dev = getQueryParam('isDev')[0] === 'true'
        }

        if (!param_auth_secret || !param_auth_appkey || !param_auth_user) {
          param_auth_secret = 'DZ__DIct-x02uCphGIOGfcAg8cp0iNIXWSpBzsyqZwsvUDE_96Pxs7L1KDS-BAAs'
          param_auth_appkey = '2jHx6BkEPg10lj3MXi5MasvvQxwevNXs'
          param_auth_user = 'ford@delosincorporated.com'
          param_is_dev = true
        }

        return { auth_secret: param_auth_secret, auth_appkey: param_auth_appkey, auth_user: param_auth_user, isDev: param_is_dev}
      }

      hmw({handler: function(o) {
          if (o.text === 'widget ready') {
            typeof mock !== 'undefined' && mock.get()
          }
          logger.value += '\n' + o.level.toUpperCase() + ': ' + o.text
          logger.scrollTop = logger.scrollHeight
        }})

      lang.value = sessionStorage.getItem('gusteauLang') || 'en-US'
      lang.addEventListener('change', function () {
        sessionStorage.setItem('gusteauLang', lang.value)
        hmw({locale: lang.value})
      })

      var d = new Date(Date.now()) // tomorrow
      // d.setMonth(11) // December
      // d.setHours(20, 40) // 8:40pm
      // tableBookingDate.value = d.toISOString().slice(0, 10)
      hmw({
        // anonymize: true,
        // user: {name: 'Amnon', phone: '+972520000000'},
        locale: lang.value,
        eventTime: d.getTime(),
        // timezone: 'Europe/Paris',
        // pickup: 'Soroka University Medical Center',
        // destination: 'Kanyon HaNegev',
        // destination: '170 Rue de Rivoli, Paris'
      })
      tableBookingDate.addEventListener('change', function () {
        var d = new Date(tableBookingDate.value)
        if (isFinite(d)) { // valid date
          d.setHours(20, 40) // 8:40pm
          hmw({eventTime: d.getTime()})
        }
      })

      var gusteauShow = function(display) {
        console.log(display);
        
        gusteau.style.display = display
        ourLocation.style.display = display
      }
      
      gusteauShow(sessionStorage.getItem('gusteauShow') || 'block')
      toggle.addEventListener('click', function () {
        var display = gusteau.style.display === 'none' ? 'block' : 'none'
        sessionStorage.setItem('gusteauShow', display)
        gusteauShow(display)
      })
      gusteauShow('none')


      document.body.className = sessionStorage.getItem('gusteauClass') || 'niceFont'
      niceFont.checked = document.body.className === 'niceFont'
      niceFont.addEventListener('input', function () {
        document.body.className = niceFont.checked ? 'niceFont' : 'plain'
        sessionStorage.setItem('gusteauClass', document.body.className)
      })

      var useServerForHMAC = false
      if (useServerForHMAC) {
        fetch('//' + location.hostname + ':3000/get-auth')
          .then(function (res) {
            return res && res.json()
          })
          .then(function (data) {
            hmw({auth: data})
          })
          .catch(function (e) {
            console.error('Failed to get auth data from Gusteau\'s server', e)
          })
        // .then() // finally / always
      } else {
        let {auth_secret, auth_appkey, auth_user, isDev} = getAuthParams()

        var auth_expire = Math.ceil(Date.now() / 1e3) + 15 * 60
        var shaObj = new jsSHA("SHA-256", "TEXT")
        shaObj.setHMACKey(auth_secret, "TEXT")
        shaObj.update([btoa(auth_appkey), btoa(auth_user), auth_expire].join('.'))
        var data = {
          application_key: auth_appkey,
          user_id: auth_user,
          expiration: auth_expire,
          hash: shaObj.getHMAC("HEX")
        }
        if (isDev) {
          hmw({dev: true})
        }
        hmw({auth: data})
      }


    </script>

    <!-- <script type="text/javascript" src="astray.js"></script> -->
    <!-- <script type="text/javascript" src="i18nPanel.js"></script> -->

  </body>
</html>